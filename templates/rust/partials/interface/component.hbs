
use std::collections::HashMap;
use std::sync::{
  Arc,
  Mutex,
};

use serde::{
  Deserialize,
  Serialize,
};
use vino_codec::messagepack::deserialize;
use vino_rpc::port::{
  Port,
  PortStream,
};
pub use vino_rpc::port::Sender;

{{#eachWithName definitions "Inputs" }}
#[derive(Debug, PartialEq, Deserialize, Serialize, Default, Clone)]
pub  struct Inputs {
  {{#each fields}}
    pub {{snakeCase name.value}}: {{> expand-type type }},
  {{/each}}
}

#[must_use]
pub fn inputs_list() -> Vec<(&'static str, &'static str)> {
    vec![{{#join fields ","}}("{{name.value}}", "{{codegen-type type}}"){{/join}}]
}

#[derive(Debug, PartialEq, Deserialize, Serialize, Default, Clone)]
pub  struct InputEncoded {
  {{#each fields}}
    #[serde(rename = "{{name.value}}")]
    pub  {{snakeCase name.value}}: Vec<u8>,
  {{/each}}
}

pub  fn deserialize_inputs(
    map: &HashMap<String, Vec<u8>>,
) -> Result<
    Inputs, Box<dyn std::error::Error + Send + Sync>,
> {
    Ok(Inputs {
      {{#each fields}}
        {{snakeCase name.value}}: deserialize(map.get("{{name.value}}").unwrap())?,
      {{/each}}
    })
}
{{/eachWithName}}


{{#eachWithName definitions "Outputs" }}
#[derive(Default, Debug)]
pub  struct Outputs {
  {{#each fields}}
    pub  {{snakeCase name.value}}: {{pascalCase name.value}}Sender,
  {{/each}}
}

#[must_use]
pub fn outputs_list() -> Vec<(&'static str, &'static str)> {
    vec![{{#join fields ","}}("{{name.value}}", "{{codegen-type type}}"){{/join}}]
}

{{#each fields}}
#[derive(Debug)]
pub  struct {{pascalCase name.value}}Sender {
    port: Arc<Mutex<Port>>,
}
impl Default for {{pascalCase name.value}}Sender {
    fn default() -> Self {
        Self {
            port: Arc::new(Mutex::new(Port::new("{{name.value}}".into()))),
        }
    }
}
impl Sender for {{pascalCase name.value}}Sender {
    type PayloadType = {{>expand-type type}};

    fn get_port(&self) -> Arc<Mutex<Port>> {
        self.port.clone()
    }
}
{{/each}}

pub  fn get_outputs() -> (Outputs, PortStream) {
    let outputs = Outputs::default();
    let ports = vec![
    {{#each fields}}
    outputs.{{snakeCase name.value}}.port.clone(),
    {{/each}}
    ];
    let stream = PortStream::new(ports);
    (outputs, stream)
}

{{/eachWithName}}

